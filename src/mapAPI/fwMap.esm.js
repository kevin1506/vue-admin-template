import e from"ol/Map.js";import View from"ol/View.js";import{Draw,Select,defaults}from"ol/interaction.js";import"ol/ol.css";import{bbox}from"ol/loadingstrategy.js";import{Vector as t,Cluster}from"ol/source.js";import"ol/geom/Point.js";import{Circle,Stroke,Fill,Icon,Style,Text}from"ol/style.js";import Feature from"ol/Feature.js";import GeoJSON from"ol/format/GeoJSON.js";import{Tile,Vector}from"ol/layer.js";import TileLayer from"ol/layer/Tile.js";import WMTS from"ol/source/WMTS.js";import WMTSTileGrid from"ol/tilegrid/WMTS.js";import Projection from"ol/proj/Projection";import ImageLayer from"ol/layer/Image.js";import ImageWMS from"ol/source/ImageWMS.js";import OSM from"ol/source/OSM.js";import XYZ from"ol/source/XYZ";import{getWidth as r,getTopLeft as o,getCenter}from"ol/extent.js";import{get as i}from"ol/proj.js";import"ol/geom/LinearRing.js";import{Point,MultiLineString,LineString,Polygon as a}from"ol/geom.js";import{DEVICE_PIXEL_RATIO}from"ol/has.js";import{linear as n}from"ol/easing.js";import{unByKey as s}from"ol/Observable.js";import{click,pointerMove,altKeyOnly}from"ol/events/condition.js";import Overlay from"ol/Overlay.js";import WKT from"ol/format/WKT.js";import echarts from"echarts";import{transform as l}from"ol/proj";import{unByKey as c}from"ol/Observable";import{Map,Object as h}from"ol";import{lineString as m,length as u,lineSliceAlong as d}from"@turf/turf";import"ol/Collection.js";import"ol/format/filter";import"ol/format";class p{constructor(e){this.$map=e,this.highRes=.01,this.maxRes=1,this.midRes=1e-5,this.lowRes=5e-6,this.osm=new Tile({source:new OSM}),this.mapBoxLayer=new Tile({preload:4,source:new XYZ({url:"https://api.mapbox.com/styles/v1/mapbox/navigation-preview-night-v4/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoicXE1NDQ4NDk0OTkiLCJhIjoiY2pqOGNtbGQ1MmNxZzN3cjVtbzg2MWNzaSJ9.njwqEIdu8irE1mPULOG0Dg"}),title:"\u77e2\u91cf\u5730\u56fe",zIndex:-1}),this.arcgisLayer=new Tile({source:new XYZ({url:"http://cache1.arcgisonline.cn/arcgis/rest/services/ChinaOnlineStreetPurplishBlue/MapServer/tile/{z}/{y}/{x}"})})}loadVectorLayer(e={}){const{maxResolution:r,geoserverIp:o,serverName:i,filter:a}=e;var n=new Vector({maxResolution:r}),s=new t({format:new GeoJSON,url:function(e){var t="BBOX(geom,"+e.join(",")+")";return a&&(t+=" and "+a),"http://"+o+"geoserver/cite/ows?service=WFS&version=1.0.0&request=GetFeature&typename=cite:"+i+"&outputFormat=application/json&CQL_FILTER="+t+"&srsname=EPSG:4326"},wrapX:!1,strategy:bbox});return n.setSource(s),n}getLayerByName(e){let t=this.$map.getLayers();for(let r=0;r<t.getLength();r++){let o=t.item(r);if(o.get("name")===e)return o}return null}getLayer(e){let t=this.$map.getLayers();for(let r=0;r<t.getLength();r++){let o=t.item(r);if(o.get("name")===e)return o.addFeature=(e=>{o.getSource().addFeature(e)}),o}return null}createVectorLayer(e={}){const{layerName:r,style:o,maxResolution:i,name:a,zIndex:n}=e;let s=new Vector({source:new t,maxResolution:i,style:o,zIndex:n});return s.set("name",r||a),s}hide(e){let t=this.getLayerByName(e);t&&t.setVisible(!1)}show(e){let t=this.getLayerByName(e);t&&t.setVisible(!0)}clear(e){let t=this.getLayerByName(e);t&&t.getSource().clear()}addFeature(e,t){let r=this.getLayerByName(e);r&&(t.set("$layername",e),r.getSource().addFeature(t),console.log(t))}remove(e,t){let r=this.getLayerByName(e);r&&r.getSource().removeFeature(t)}getFeatures(e){let t=this.getLayerByName(e);if(t)return t.getSource().getFeatures()}}class g{constructor(e){this.$map=e,this.$layer=new p(e)}addLayer(e){this.$map.addLayer(e)}addGeoserverWFSLayer(e={}){const{maxResolution:r,geoserverIp:o,serverName:i,filter:a,layerName:n,visible:s,onLoad:l,zIndex:c}=e;let h=new Vector({maxResolution:r,style:e.style,zIndex:c});h.set("name",n);let m=new t({format:new GeoJSON,loader:function(e,t,r){let a="http://"+o+"/geoserver/cite/ows?service=WFS&version=1.0.0&request=GetFeature&typename=cite:"+i+"&outputFormat=application/json&srsname=EPSG:4326&bbox="+e.join(",")+",EPSG:4326",n=new XMLHttpRequest;n.open("GET",a);let s=function(){m.removeLoadedExtent(e)};n.onerror=s,n.onload=function(){if(200==n.status)try{let e=m.getFormat().readFeatures(n.responseText);m.addFeatures(e),l&&l(e)}catch(e){console.log(e)}else s()},n.send()},wrapX:!1,strategy:bbox});h.setSource(m),void 0!==s&&h.setVisible(s),this.addLayer(h)}addGeoserverWMTSLayer(e){const{geoserverIp:t,serveName:r,extent:o,layerName:i}=e;let a="http://"+t+"/geoserver/gwc/service/wmts",n=new Projection({code:"EPSG:4326",units:"degrees",axisOrientation:"neu"}),s=["VERSION","LAYER","STYLE","TILEMATRIX","TILEMATRIXSET","SERVICE","FORMAT"],l={VERSION:"1.0.0",LAYER:"cite:"+r,STYLE:"",TILEMATRIX:["EPSG:4326:0","EPSG:4326:1","EPSG:4326:2","EPSG:4326:3","EPSG:4326:4","EPSG:4326:5","EPSG:4326:6","EPSG:4326:7","EPSG:4326:8","EPSG:4326:9","EPSG:4326:10","EPSG:4326:11","EPSG:4326:12","EPSG:4326:13","EPSG:4326:14","EPSG:4326:15","EPSG:4326:16","EPSG:4326:17","EPSG:4326:18","EPSG:4326:19","EPSG:4326:20","EPSG:4326:21"],TILEMATRIXSET:"EPSG:4326",SERVICE:"WMTS",FORMAT:"image/png"},c=a+"?";for(let e in l)s.indexOf(e.toUpperCase())<0&&(c=c+e+"="+l[e]+"&");let h={url:c=c.slice(0,-1),layer:l.LAYER,matrixSet:l.TILEMATRIXSET,format:l.FORMAT,projection:n,tileGrid:new WMTSTileGrid({tileSize:[256,256],extent:o||[-180,-90,180,90],origin:[-180,90],resolutions:[.703125,.3515625,.17578125,.087890625,.0439453125,.02197265625,.010986328125,.0054931640625,.00274658203125,.001373291015625,.0006866455078125,.00034332275390625,.000171661376953125,858306884765625e-19,4291534423828125e-20,21457672119140625e-21,10728836059570312e-21,5364418029785156e-21,2682209014892578e-21,1341104507446289e-21,6.705522537231445e-7,3.3527612686157227e-7],matrixIds:l.TILEMATRIX}),style:l.STYLE,wrapX:!0},m=new WMTS(h),u=new TileLayer({source:m});u.set("name",i),this.$map.addLayer(u)}addWMTSLayer(e){let t=i("EPSG:4326"),a=t.getExtent(),n=r(a)/256,s=new Array(18),l=new Array(18);for(let e=0;e<18;++e)s[e]=n/Math.pow(2,e+1),l[e]="EPSG:4326:"+e;let c=new TileLayer({type:"base",title:"\u536b\u661f\u5f71\u50cf\u56fe",source:new WMTS({url:"http://192.168.200.191:8080/geoserver/gwc/demo/wmts",layer:"cite:gaosu_map",matrixSet:"EPSG:4326",format:"image/png",projection:t,tileGrid:new WMTSTileGrid({origin:o(a),resolutions:s,matrixIds:l}),wrapX:!0})});this.$map.addLayer(c)}addClusterLayer(e={}){const{features:r,textColor:o,src:i,anchor:a,opacity:n,layerName:s}=e;let l,c=new t({features:r}),h=new Cluster({distance:parseInt(30,10),source:c}),m={};l=i?new Icon({anchor:a,opacity:n||.95,src:i}):new Circle({radius:10,stroke:new Stroke({color:"#fff"}),fill:new Fill({color:"#3399CC"})});let u=new Vector({source:h,name:s,style:function(e){let t=e.get("features").length,r=m[t];return r||(r=new Style({image:l,text:new Text({text:t.toString(),fill:new Fill({color:o||"#fff"})})}),m[t]=r),r}});this.$map.addLayer(u)}addWMSLayer(e={}){const{url:t,params:r,serverType:o,crossOrigin:i,layerName:a}=e;let n=new ImageWMS({url:t,params:r,serverType:o||"geoserver",crossOrigin:i||"anonymous"}),s=new ImageLayer({name:a,source:n,projection:new Projection({code:"EPSG:4326",units:"degrees",axisOrientation:"neu"})});this.$map.addLayer(s)}removeLayer(e){let t=this.$layer.getLayerByName(e);t&&this.$map.removeLayer(t)}}class f{constructor(e){this.$map=e}zoomIn(e){this.getView().setZoom(this.getZoom()+(e||1))}zoomOut(e){this.getView().setZoom(this.getZoom()-(e||1))}getZoom(){return this.getView().getZoom()}setZoom(e){this.getView().setZoom(e)}getView(){return this.$map.getView()}onChange(e){this.getView().on("change:resolution",()=>{let t=this.getZoom();e&&e(t)})}getResolution(){return this.getView().getResolution()}setCenter(e){this.getView().setCenter(e)}getCenter(){return this.getView().getCenter()}moveCenterByPixel(e={}){const{offset:t,duration:r,zoom:o}=e;let i=this.getCenter(),a=this.$map.getPixelFromCoordinate(i),n=[a[0]+t[0],a[1]+t[1]],s=this.$map.getCoordinateFromPixel(n);return this.getView().animate({center:s,zoom:o,duration:r||2e3}),s}animate(e={}){const{center:t,zoom:r,duration:o}=e;this.getView().animate({center:t,zoom:r,duration:o||2e3})}fit(e={}){const{feature:t,maxZoom:r,duration:o}=e;this.getView().fit(t.getGeometry().getExtent(),{maxZoom:r||14,duration:o||500})}}class y{constructor(e){this.$map=e,this.name="1234",this.view=new f(e)}styleFunction(e){return(t,r)=>{const{getStrokeColor:o,getStrokeWidth:i,getLineDash:a,getFillColor:n,getText:s,getTextColor:l,getTextRotation:c,textColor:h,rotation:m,text:u,placement:d,offsetX:p,offsetY:g,fontScale:f}=e;let y={stroke:new Stroke({color:o&&o(t)||e.strokeColor||"transparent",width:i&&i(t)||e.strokeWidth,lineDash:a&&a(t)||e.lineDash}),fill:new Fill({color:n&&n(t)||e.fillColor}),text:new Text({scale:f,text:s&&s(t,r)||u,fill:new Fill({color:l&&l(t)||h}),offsetX:p,offsetY:g,placement:d||"point",rotation:c&&c(t)||m})};if(e.icon){const{anchor:r,src:o,opacity:i,size:a,imgSize:n,scaleLevel:s,scale:l,getScale:c,rotation:h,getRotation:m,getSrc:u}=e.icon;let d;s&&(d=this.getScale(s)),y.image=new Icon({anchor:r,opacity:i||.95,src:u&&u(t)||o,size:a,imgSize:n,scale:c&&c(this.view.getZoom())||l||d,rotation:m&&m(t)||h})}return new Style(y)}}fill(e){return new Style({stroke:new Stroke({color:e.strokeColor||"transparent",width:e.strokeWidth,lineDash:e.lineDash}),fill:new Fill({color:e.fillColor})})}circle(e={}){const{color:t,radius:r,width:o,strokeColor:i}=e;return new Style({image:new Circle({radius:r||5,fill:new Fill({color:t||"#f00"}),stroke:new Stroke({color:i||"transparent",width:o})})})}stroke(e){const{color:t,strokeColor:r,width:o,strokeWidth:i,lineDash:a,lineCap:n}=e;return new Style({stroke:new Stroke({color:t||r||"transparent",width:o||i,lineDash:a,lineCap:n||"square"})})}icon(e){const{anchor:t,src:r,opacity:o,size:i,imgSize:a,scaleLevel:n,scale:s}=e;return e=>{let l;return n&&(l=this.getScale(n)),new Style({image:new Icon({anchor:t,opacity:o||.95,src:r,size:i,imgSize:a,scale:s||l})})}}getArrowStyle(e={}){return e=>{let t="#f00";this.$map.on("postcompose",e=>{let r=e.frameState.index;console.log(r),t=r%2==0?"#0f0":"#f00"});if(!e)return;let r=[],o=null;if("MultiLineString"===e.getGeometry().getType()){o=e.getGeometry().getLineStrings()[0]}else o=e.getGeometry();let i=this.$map.getView().getResolution(),a=288/(2*Math.PI*6378137)/i,n=new Style({geometry:o,stroke:new Stroke({color:"white",width:a,LineCap:"round"})});return r.push(n),this.styleCrane(o,t,.8,r),r}}styleCrane(e,t,r,o){let i=this,a=e.getCoordinates(),n=DEVICE_PIXEL_RATIO,s=i.$map.getView().getResolution();for(let e=0;e<a.length-1;e++){let r=a[e],l=a[e+1],c=l[0]-r[0],h=l[1]-r[1],m=Math.atan2(h,c),u=i.$map.getPixelFromCoordinate(r),d=i.$map.getPixelFromCoordinate(l),p=i.pointDst2d(u,d),g=200,f=120,y=(f=360*f/(2*Math.PI*6378137))/s*n,v=(g=360*g/(2*Math.PI*6378137))/s*n,w=document.createElement("canvas");if(w.width=y,w.height=p,null===w)return!1;0===w.height&&(w.height=2),0===w.width&&(w.width=2);let S=w.getContext("2d"),$=i.patternCrane(v,y,t);S.fillStyle=$,S.fillRect(0,0,w.width,w.height);let L=(l[0]+r[0])/2,M=(l[1]+r[1])/2;o.push(new Style({geometry:new Point([L,M]),image:new Icon({src:void 0,img:w,imgSize:w?[w.width,w.height]:void 0,rotation:-m+Math.PI/2,rotateWithView:!1})}))}}patternCrane(e,t,r){let o=document.createElement("canvas"),i=o.getContext("2d");return o.height=e*DEVICE_PIXEL_RATIO>1?e*DEVICE_PIXEL_RATIO:1,o.width=t*DEVICE_PIXEL_RATIO>1?t*DEVICE_PIXEL_RATIO:1,i.fillStyle="rgba(0,0,0,0)",i.fillRect(0,0,o.width,o.height),i.beginPath(),i.moveTo(0,e/3),i.lineTo(0,2*e/3),i.lineTo(t/2,e/3),i.lineTo(t,2*e/3),i.lineTo(t,e/3),i.lineTo(t/2,0),i.closePath(),i.fillStyle=r,i.fill(),i.createPattern(o,"repeat")}getScale(e=105){var t=8e5*this.view.getResolution();return this.view.getZoom()/(e*t)*DEVICE_PIXEL_RATIO}facilityStyle(e){let t;switch(e){case"roadline":t=this.roadlineStyle()}return t}roadlineStyle(){var e=this;return function(t){var r=t.get("styleid")||t.get("typeid"),o=t.get("color");o=1===o?"#ff0":"#fff";var i=new Stroke({color:"transparent",width:0}),a=[],n=new Style({stroke:i});switch(a.push(n),parseInt(r,0)){case 241:case 248:i.setColor(o),i.setWidth(e.getMetricWidth(.3)),n.setGeometry(function(t){var r=null;"MultiLineString"===t.getGeometry().getType()?r=t.getGeometry().getLineStrings()[0]:r=t.getGeometry();var o=e.offsetLine(r,.5,1),i=new MultiLineString([]);return i.appendLineString(r),i.appendLineString(o),i});break;case 244:case 227:i.setColor(o),i.setWidth(e.getMetricWidth(.2));break;case 245:i.setColor("transparent"),i.setWidth(e.getMetricWidth(.05));let s=new Style({geometry:function(e){var t=null;"MultiLineString"===e.getGeometry().getType()?t=e.getGeometry().getLineStrings()[0]:t=e.getGeometry();return t},stroke:new Stroke({color:"white",width:e.getMetricWidth(.4)})}),l=new Style({geometry:function(e){var t=null;"MultiLineString"===e.getGeometry().getType()?t=e.getGeometry().getLineStrings()[0]:t=e.getGeometry();return t},stroke:new Stroke({color:"yellow",width:e.getMetricWidth(.4),lineCap:"square",lineDash:[e.getMetricWidth(1.5),e.getMetricWidth(1.5)]})});a.push(l),a.push(s),a.reverse();break;case 246:case 247:i.setColor(o),i.setWidth(e.getMetricWidth(.3));break;case 249:i.setColor(o),i.setLineCap("square"),i.setLineDash([e.getMetricWidth(.8),e.getMetricWidth(.8)]),i.setWidth(e.getMetricWidth(.3)),n.setGeometry(function(t){var r=null;"MultiLineString"===t.getGeometry().getType()?r=t.getGeometry().getLineStrings()[0]:r=t.getGeometry();var o=e.offsetLine(r,.5,1),i=new MultiLineString([]);return i.appendLineString(r),i.appendLineString(o),i});break;case 250:i.setColor(o),i.setWidth(e.getMetricWidth(.2)),i.setLineCap("square"),i.setLineDash([e.getMetricWidth(.8),e.getMetricWidth(.8)]);break;case 252:case 205:case 221:i.setColor(o),i.setWidth(e.getMetricWidth(.2));break;case 254:i.setColor(o),i.setWidth(e.getMetricWidth(.5)),i.setLineCap("square"),i.setLineDash([e.getMetricWidth(.3),e.getMetricWidth(2)]);break;case 209:i.setColor(o),i.setWidth(e.getMetricWidth(.8)),i.setLineCap("square"),i.setLineDash([e.getMetricWidth(.5),e.getMetricWidth(4)]);break;case 210:i.setColor(o),i.setWidth(e.getMetricWidth(.8));break;case 220:i.setColor(o),i.setWidth(e.getMetricWidth(.2)),i.setLineCap("square"),i.setLineDash([e.getMetricWidth(3.5),e.getMetricWidth(4)]);break;case 222:i.setColor(o),i.setLineCap("square"),i.setLineDash([e.getMetricWidth(2),e.getMetricWidth(1)]),i.setWidth(e.getMetricWidth(.2)),n.setGeometry(function(t){var r=null;"MultiLineString"===t.getGeometry().getType()?r=t.getGeometry().getLineStrings()[0]:r=t.getGeometry();var o=e.offsetLine(r,.5,-1),i=new MultiLineString([]);return i.appendLineString(o),i});let c=new Style({geometry:function(t){var r=null;"MultiLineString"===t.getGeometry().getType()?r=t.getGeometry().getLineStrings()[0]:r=t.getGeometry();return e.offsetLine(r,.25,1)},stroke:new Stroke({color:o,width:e.getMetricWidth(.2)})});a.push(c);break;case 223:i.setColor(o),i.setWidth(e.getMetricWidth(.2)),n.setGeometry(function(t){var r=null;"MultiLineString"===t.getGeometry().getType()?r=t.getGeometry().getLineStrings()[0]:r=t.getGeometry();var o=e.offsetLine(r,.5,1),i=new MultiLineString([]);return i.appendLineString(r),i.appendLineString(o),i});break;case 224:case 225:case 226:i.setColor(o),i.setWidth(e.getMetricWidth(.2)),i.setLineCap("square"),i.setLineDash([e.getMetricWidth(2),e.getMetricWidth(3)]);break;case 228:i.setColor(o),i.setWidth(e.getMetricWidth(.2)),i.setLineCap("square"),i.setLineDash([e.getMetricWidth(1),e.getMetricWidth(1)]);break;case 229:i.setColor(o),i.setWidth(e.getMetricWidth(.2)),i.setLineCap("square"),i.setLineDash([e.getMetricWidth(1.8),e.getMetricWidth(2)]);break;case 230:i.setColor(o),i.setWidth(e.getMetricWidth(.3));break;case 231:case 232:case 236:i.setColor("rgba(0,0,0,0)"),e.zebarlineStyle(t,r,o,a);break;case 233:i.setColor("rgba(0,0,0,0)"),e.vehicleDistanceLineStyle(t,o,a);break;case 234:i.setColor(o),i.setWidth(e.getMetricWidth(.4)),i.setLineCap("square"),i.setLineDash([e.getMetricWidth(.5),e.getMetricWidth(2)]);break;case 238:i.setColor(o),i.setWidth(e.getMetricWidth(.4)),i.setLineCap("square"),i.setLineDash([e.getMetricWidth(.5),e.getMetricWidth(1.5)]);break;case 239:i.setLineCap("square"),i.setColor(o),i.setWidth(e.getMetricWidth(.4));break;case 240:i.setColor(o),i.setWidth(e.getMetricWidth(.3));break;case 255:i.setColor(o),i.setLineCap("square"),i.setLineDash([e.getMetricWidth(2),e.getMetricWidth(3)]),i.setWidth(e.getMetricWidth(.2)),n.setGeometry(function(t){var r=null;"MultiLineString"===t.getGeometry().getType()?r=t.getGeometry().getLineStrings()[0]:r=t.getGeometry();var o=e.offsetLine(r,.5,1),i=new MultiLineString([]);return i.appendLineString(r),i.appendLineString(o),i});break;case 206:i.setColor(o),i.setWidth(e.getMetricWidth(.2));break;case 235:i.setColor(o),i.setLineCap("square"),i.setLineDash([e.getMetricWidth(1.8),e.getMetricWidth(.8)]),i.setWidth(e.getMetricWidth(.2)),n.setGeometry(function(t){var r=null;"MultiLineString"===t.getGeometry().getType()?r=t.getGeometry().getLineStrings()[0]:r=t.getGeometry();var o=e.offsetLine(r,.5,1),i=new MultiLineString([]);return i.appendLineString(r),i.appendLineString(o),i})}return a}}getMetricWidth(e){let t=DEVICE_PIXEL_RATIO,r=this.$map.getView().getResolution();return 360*e/(2*Math.PI*6378137)/r*t}lineOffset(e,t,r){let o=this,i=e.getCoordinates(),a=[];for(let e=0;e<i.length;e++)if(0===e){let n=0;if(-1===r){let t=i[e][0]-i[e+1][0],r=i[e][1]-i[e+1][1];n=Math.atan2(r,t)}else{let t=i[e+1][0]-i[e][0],r=i[e+1][1]-i[e][1];n=Math.atan2(r,t)}a.push(o.pointOffset(i[e],t,Math.PI-n))}else if(e<i.length-1){if(o.unitConversion(o.pointDst2d(i[e],i[e-1]),"a")<1)continue;let n=o.pointAzimuthAngle(i[e],i[e-1]),s=o.pointAzimuthAngle(i[e],i[e+1]),l=0,c=0,h=0;n>s?(l=n-s,-1===r?(c=n+(l=360-l)/2,l*=Math.PI/180,h=t/Math.cos(l/2-Math.PI/2)):(c=n-l/2,l*=Math.PI/180,h=t/Math.sin(l/2))):(l=s-n,1===r?(c=s+(l=360-l)/2,l*=Math.PI/180,h=t/Math.cos(l/2-Math.PI/2)):(c=s-l/2,l*=Math.PI/180,h=t/Math.sin(l/2)));let m=o.pointOffset(i[e],h,c*(Math.PI/180));a.push(m)}else{let n=0;if(-1===r){let t=i[e-1][0]-i[e][0],r=i[e-1][1]-i[e][1];n=Math.atan2(r,t)}else{let t=i[e][0]-i[e-1][0],r=i[e][1]-i[e-1][1];n=Math.atan2(r,t)}a.push(o.pointOffset(i[e],t,Math.PI-n))}return-1===r&&a.reverse(),new LineString(a)}pointOffset(e,t,r){let o=e[1]*Math.PI/180,i=e[0]*Math.PI/180,a=t/6378137,n=Math.asin(Math.sin(o)*Math.cos(a)+Math.cos(o)*Math.sin(a)*Math.cos(r));return[180*(i+Math.atan2(Math.sin(r)*Math.sin(a)*Math.cos(o),Math.cos(a)-Math.sin(o)*Math.sin(n)))/Math.PI,180*n/Math.PI]}unitConversion(e,t){return"m"===t?360*e/(2*Math.PI*6378137):"a"===t?e*Math.PI*6378137/180:void 0}pointDst2d(e,t){let r=e[0]-t[0],o=e[1]-t[1];return Math.sqrt(r*r+o*o)}pointAzimuthAngle(e,t){let r=t[0]-e[0],o=t[1]-e[1],i=Math.atan2(r,o);return(i=180*i/Math.PI)<0&&(i+=360),i%360}offsetLine(e,t,r){let o=this,i=e.getCoordinates(),a=[];for(let e=0;e<i.length;e++)if(0===e){let n=0;if(-1===r){let t=i[e][0]-i[e+1][0],r=i[e][1]-i[e+1][1];n=Math.atan2(r,t)}else{let t=i[e+1][0]-i[e][0],r=i[e+1][1]-i[e][1];n=Math.atan2(r,t)}a.push(o.pointOffset(i[e],t,Math.PI-n))}else if(e<i.length-1){if(o.unitConversion(o.pointDst2d(i[e],i[e-1]),"a")<1)continue;let n=o.pointAzimuthAngle(i[e],i[e-1]),s=o.pointAzimuthAngle(i[e],i[e+1]),l=0,c=0,h=0;n>s?(l=n-s,-1===r?(c=n+(l=360-l)/2,l*=Math.PI/180,h=t/Math.cos(l/2-Math.PI/2)):(c=n-l/2,l*=Math.PI/180,h=t/Math.sin(l/2))):(l=s-n,1===r?(c=s+(l=360-l)/2,l*=Math.PI/180,h=t/Math.cos(l/2-Math.PI/2)):(c=s-l/2,l*=Math.PI/180,h=t/Math.sin(l/2)));let m=o.pointOffset(i[e],h,c*(Math.PI/180));a.push(m)}else{let n=0;if(-1===r){let t=i[e-1][0]-i[e][0],r=i[e-1][1]-i[e][1];n=Math.atan2(r,t)}else{let t=i[e][0]-i[e-1][0],r=i[e][1]-i[e-1][1];n=Math.atan2(r,t)}a.push(o.pointOffset(i[e],t,Math.PI-n))}return-1===r&&a.reverse(),new LineString(a)}zebarlineStyle(e,t,r,o){var i=e.getGeometry().getFirstCoordinate(),a=e.getGeometry().getLastCoordinate(),n=a[0]-i[0],s=a[1]-i[1],l=Math.atan2(s,n),c=DEVICE_PIXEL_RATIO,h=this.$map.getView().getResolution(),m=this.$map.getPixelFromCoordinate(i),u=this.$map.getPixelFromCoordinate(a),d=this.pointDst2d(m,u),p=3,g=1,f=(p=360*p/(2*Math.PI*6378137))/h*c,y=(g=360*g/(2*Math.PI*6378137))/h*c,v=document.createElement("canvas");if(v.width=f,v.height=d,null===v)return!1;v.height<2&&(v.height=2),v.width<2&&(v.width=2);var w=v.getContext("2d"),S=this.patternZebra(y,f,t,r);w.fillStyle=S,w.fillRect(0,0,v.width,v.height);var $=(a[0]+i[0])/2,L=(a[1]+i[1])/2;o.push(new Style({geometry:new Point([$,L]),image:new Icon({src:void 0,img:v,imgSize:v?[v.width,v.height]:void 0,rotation:-l+Math.PI/2,rotateWithView:!1})}))}patternZebra(e,t,r,o){var i=document.createElement("canvas"),a=i.getContext("2d");return i.height=e*DEVICE_PIXEL_RATIO>1?e*DEVICE_PIXEL_RATIO:1,i.width=t*DEVICE_PIXEL_RATIO>1?t*DEVICE_PIXEL_RATIO:1,a.fillStyle="rgba(0,0,0,0)",a.fillRect(0,0,i.width,i.height),231===r&&(a.beginPath(),a.moveTo(0,e/2),a.lineTo(t,e/2),a.lineTo(t,e),a.lineTo(0,e),a.closePath(),a.fillStyle=o,a.fill()),232===r&&(a.beginPath(),a.moveTo(0,0),a.lineTo(t,e/2),a.lineTo(t,e),a.lineTo(0,e/2),a.closePath(),a.fillStyle=o,a.fill()),236===r&&(a.beginPath(),a.moveTo(0,e/2),a.lineTo(t,0),a.lineTo(t,e/2),a.lineTo(0,e),a.closePath(),a.fillStyle=o,a.fill()),a.createPattern(i,"repeat")}vehicleDistanceLineStyle(e,t,r){var o=e.getGeometry().getFirstCoordinate(),i=e.getGeometry().getLastCoordinate(),a=i[0]-o[0],n=i[1]-o[1],s=Math.atan2(n,a),l=DEVICE_PIXEL_RATIO,c=this.$map.getView().getResolution(),h=this.$map.getPixelFromCoordinate(o),m=this.$map.getPixelFromCoordinate(i),u=this.pointDst2d(h,m),d=3,p=3,g=(d=360*d/(2*Math.PI*6378137))/c*l,f=(p=360*p/(2*Math.PI*6378137))/c*l,y=document.createElement("canvas");if(y.width=g,y.height=u,null===y)return!1;y.height<10&&(y.height=10),y.width<10&&(y.width=10);var v=y.getContext("2d"),w=this.patternDistanceLine(f,g,t);v.fillStyle=w,v.fillRect(0,0,y.width,y.height);var S=(i[0]+o[0])/2,$=(i[1]+o[1])/2;r.push(new Style({geometry:new Point([S,$]),image:new Icon({src:void 0,img:y,imgSize:y?[y.width,y.height]:void 0,rotation:-s+Math.PI/2,rotateWithView:!1})}))}patternDistanceLine(e,t,r){var o=document.createElement("canvas"),i=o.getContext("2d");return o.height=e*DEVICE_PIXEL_RATIO>1?e*DEVICE_PIXEL_RATIO:1,o.width=t*DEVICE_PIXEL_RATIO>1?t*DEVICE_PIXEL_RATIO:1,i.fillStyle="rgba(0,0,0,0)",i.fillRect(0,0,o.width,o.height),i.beginPath(),i.moveTo(0,e/10),i.lineTo(t,e/10),i.lineTo(t,0),i.lineTo(0,0),i.closePath(),i.fillStyle=r,i.fill(),i.createPattern(o,"repeat")}flashFeature(e){let t=this.$map;var r=3e3;!function(e){var o=(new Date).getTime(),i=t.on("postcompose",function(a){var l=a.vectorContext,c=a.frameState,h=e.getGeometry().clone(),m=c.time-o,u=m/r,d=25*n(u)+5,p=n(1-2*u);p=n(2*u>=1?u:1-2*u);var g=new Style({image:new Circle({radius:d,stroke:new Stroke({color:"rgba(255, 0, 0, "+p+")",width:.25+p})}),stroke:new Stroke({color:"rgba(255, 0, 0, "+p+")",width:3+p})});l.setStyle(g),l.drawGeometry(h),m>r?s(i):t.render()})}(e)}}class v{constructor(e){this.$map=e,this.$drawlayer=new Vector({source:new t}),this.$draw=void 0,this.$select=void 0,this.$interactions=[this.$draw,this.$select],this.$layer=new p(e)}draw(e={}){const{drawEnd:t,type:r}=e;this.$draw&&this.$map.removeInteraction(this.$draw),this.$draw=new Draw({type:r||"LineString",source:this.$drawlayer.getSource()}),this.$map.addInteraction(this.$draw),this.$draw.on("drawend",e=>{t&&t(e.feature,e)})}select(e={}){const{condition:t,hitTolerance:r,layers:o,onSelect:i,style:a,filter:n}=e;let s,l,c,h;switch(o&&(s=((e,t)=>(l=t,-1!=o.indexOf(t.get("name"))))),this.$select&&this.$map.removeInteraction(this.$select),null===a&&(c=new Style({stroke:new Stroke({color:"transparent"}),fill:new Fill({color:"transparent"})})),console.log(c),t){case"click":h=click;break;case"pointerMove":h=pointerMove;break;case"altKeyOnly":h=altKeyOnly;break;default:h=click}this.$select=new Select({condition:h||click,hitTolerance:r,filter:n||s,style:a||c}),this.$select.on("select",e=>{const{selected:t}=e;t&&i&&i(t,l,e)}),this.$map.addInteraction(this.$select)}hover(e){let t=this.$map;t.un("pointermove"),t.on("pointermove",function(r){let o=t.getEventPixel(r.originalEvent),i=t.getCoordinateFromPixel(o),a=t.forEachFeatureAtPixel(o,function(t){return e&&e(t,i),t});null==a?(t.getTargetElement().style.cursor="default",e&&e(a,i)):t.getTargetElement().style.cursor="pointer"})}singleClick(e={}){const{onClick:t}=e;let r=this.$map;r.on("singleclick",e=>{let o=r.getEventPixel(e.originalEvent),i=r.getCoordinateFromPixel(o),a=r.forEachFeatureAtPixel(o,function(e){return console.log(e),e});t&&t(a,i),console.log(e)})}dblClick(e){const{onClick:t}=e;let r=this.$map;r.on("dblclick",e=>{let o=r.getEventPixel(e.originalEvent),i=r.getCoordinateFromPixel(o);t&&t(i)})}unbind(){this.$map.un("pointermove"),this.$map.un("singleclick")}close(e){const t=this.$map;if(e)switch(e){case"select":this.$select&&t.removeInteraction(this.$select);break;case"draw":this.$draw&&t.removeInteraction(this.$draw);break;case"singleClick":case"pointermove":t.un(e);break;default:console.error("\u65e0\u6cd5\u79fb\u9664\u4e0d\u5b58\u5728\u7684\u4ea4\u4e92\u7c7b\u578b")}else this.$map.un("pointermove"),this.$map.un("singleclick"),this.$map.un("dblclick"),this.$interactions.forEach(e=>{e&&this.$map.removeInteraction(e)})}addFeature(e){new Feature({geometry:new Point([0,0]),name:"Null Island",population:4e3,rainfall:500})}createPointFeature(e,t){return new Feature({geometry:new Point(e),...t})}createFeature(e,t,r){let o;switch(e.toLowerCase()){case"linestring":o=new LineString(t);break;case"polygon":o=new a(t);break;default:o=new Point(t)}return console.log(o),new Feature({geometry:o,...r})}}class w{constructor(e){this.$map=e}popup(e={}){const{pos:t,id:r,placement:o,offset:i,html:a,className:n,onClick:s,onMouseOver:l,attr:c}=e;let h;if(a){let e=document.createElement("div");e.innerHTML=a,e.classList.add(n),h=e}else h=document.getElementById(r);if(c)for(let e in c)h.setAttribute(e,c[e]);h.onclick=(()=>{s&&s(h)}),h.onmouseover=(()=>{l&&l(h)}),h.onmouseover=l,this.$popup=new Overlay({id:r,element:h,position:t,positioning:o,offset:i,autoPanAnimation:{duration:250}}),this.$map.addOverlay(this.$popup)}hidePopup(e){let t=this.getPopup(e);t&&t.setPosition(void 0)}getPopup(e){return this.$map.getOverlayById(e)}addLabel(e={}){let{feature:t,textBaseline:r,padding:o,placement:i,featureStyle:a,text:n,background:s,textColor:l,strokeColor:c,strokeWidth:h}=e;a=a||{},t.setStyle(e=>new Style({stroke:new Stroke({color:a.color||"blue",width:a.width||1}),fill:new Fill({color:a.fill||"rgba(0, 0, 255, 0.1)"}),text:new Text({text:n||"\u8bf7\u8f93\u5165\u6587\u5b57",placement:i||"line",textBaseline:r||"top",padding:o||[5,5,5,5],fill:new Fill({color:l||"#fff"}),stroke:new Stroke({color:c||"#000",width:h||5}),backgroundFill:new Fill({color:s||"rgba(0 0 0)"}),font:"12px Calibri,sans-serif",overflow:!0})}))}wktToFeature(e){return(new WKT).readFeature(e,{dataProjection:"EPSG:4326",featureProjection:"EPSG:4326"})}}var S="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},$=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},L=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},M=function(e){var t=void 0===e?"undefined":S(e);return null!==e&&("object"===t||"function"===t)},b=function e(t,r){for(var o in r)M(r[o])&&M(t[o])?e(t[o],r[o]):t[o]=r[o];return t},C=function(e){var t,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:document;return t=void 0,r&&/^#([\w-]+)$/.test(e)?(t=r.getElementById(RegExp.$1))?[t]:[]:Array.prototype.slice.call(/^\.([\w-]+)$/.test(e)?r.getElementsByClassName(RegExp.$1):/^[\w-]+$/.test(e)?r.getElementsByTagName(e):r.querySelectorAll(e))},P=function(e,t,r){if(e&&t){if(e.map&&e.map===Array.prototype.map)return e.map(t,r);for(var o=[],i=0,a=e.length;i<a;i++)o.push(t.call(r,e[i],i,e));return o}},E=function(e,t){var r=Array.prototype.slice.call(arguments,2);return function(){return e.apply(t,r.concat(Array.prototype.slice.call(arguments)))}},x=function(e){if(function(e){return!e.UTF8Encoding}(e))return e;var t=e.UTF8Scale;null==t&&(t=1024);for(var r=e.features,o=0;o<r.length;o++)for(var i=r[o].geometry,a=[i.coordinates,i.encodeOffsets],n=a[0],s=a[1],l=0;l<n.length;l++){var c=n[l];if("Polygon"===i.type)n[l]=T(c,s[l],t);else if("MultiPolygon"===i.type)for(var h=0;h<c.length;h++){var m=c[h];c[h]=T(m,s[l][h],t)}}return e.UTF8Encoding=!1,e},T=function(e,t,r){for(var o=[[],t[0],t[1]],i=o[0],a=o[1],n=o[2],s=0;s<e.length;s+=2){var l=e.charCodeAt(s)-64,c=e.charCodeAt(s+1)-64;l=l>>1^-(1&l),c=c>>1^-(1&c),a=l+=a,n=c+=n,i.push([l/r,c/r])}return i};var I=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=function(){this._mapOffset=[0,0],this.dimensions=["lng","lat"],this.projCode_=this._getProjectionCode()};return r.prototype.dimensions=["lng","lat"],r.dimensions=r.prototype.dimensions,r.prototype.getZoom=function(){return e.getView().getZoom()},r.prototype.setZoom=function(t){return e.getView().setZoom(t)},r.prototype.getViewRectAfterRoam=function(){return this.getViewRect().clone()},r.prototype.setMapOffset=function(e){this._mapOffset=e},r.prototype.dataToPoint=function(r){r&&Array.isArray(r)&&r.length>0&&(r=r.map(function(e){return"string"==typeof e&&(e=Number(e)),e}));var o=t.source||"EPSG:4326",i=t.destination||this.projCode_,a=e.getPixelFromCoordinate(l(r,o,i)),n=this._mapOffset;return[a[0]-n[0],a[1]-n[1]]},r.prototype._getProjectionCode=function(){return e?e.getView()&&e.getView().getProjection().getCode():"EPSG:3857"},r.prototype.pointToData=function(t){var r=this._mapOffset;return e.getCoordinateFromPixel([t[0]+r[0],t[1]+r[1]])},r.prototype.getViewRect=function(){var t=e.getSize();return new echarts.graphic.BoundingRect(0,0,t[0],t[1])},r.prototype.getRoamTransform=function(){return echarts.matrix.create()},r.prototype.prepareCustoms=function(e){var t=this.getViewRect();return{coordSys:{type:"openlayers",x:t.x,y:t.y,width:t.width,height:t.height},api:{coord:E(this.dataToPoint,this),size:E(r.dataToCoordSize,this)}}},r.dataToCoordSize=function(e,t){return t=t||[0,0],P([0,1],function(r){var o=t[r],i=e[r]/2,a=[],n=[];return a[r]=o-i,n[r]=o+i,a[1-r]=n[1-r]=t[1-r],Math.abs(this.dataToPoint(a)[r]-this.dataToPoint(n)[r])},this)},r.create=function(t,o){t.eachSeries(function(t){"openlayers"===t.get("coordinateSystem")&&(t.coordinateSystem=new r(e))})},r},z=Object.freeze({pie:function(e,t,r){return t.center=r.dataToPoint(t.coordinates),t},bar:function(e,t,r){return M(e.grid)&&!Array.isArray(e.grid)?console.log(e):Array.isArray(e.grid)&&(e.grid=e.grid.map(function(t,o){var i=r.dataToPoint(e.series[o].coordinates);return t.left=i[0]-parseFloat(t.width)/2,t.top=i[1]-parseFloat(t.height)/2,t})),t}}),k={forcedRerender:!1,forcedPrecomposeRerender:!1,hideOnZooming:!1,hideOnMoving:!1,hideOnRotating:!1,convertTypes:["pie","line","bar"]},EChartsLayer=function(e){function EChartsLayer(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=arguments[2];$(this,EChartsLayer);var i=L(this,e.call(this));return i.$options=b(k,r),i.$chartOptions=t,i.$chart=null,i.$Map=null,i._isRegistered=!1,i._incremental=[],i._coordinateSystem=null,o&&i.appendTo(o),i}return function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}(EChartsLayer,e),EChartsLayer.prototype.appendTo=function(e){var t=this;if(!(e&&e instanceof Map))throw new Error("not map object");this.$Map=e,this.$Map.once("postrender",function(e){t.render()}),this.$Map.renderSync(),this._unRegisterEvents(),this._registerEvents()},EChartsLayer.prototype.getChartOptions=function(){return this.$chartOptions},EChartsLayer.prototype.setChartOptions=function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};return this.$chartOptions=t,this.$Map.once("postrender",function(t){e.render()}),this.$Map.renderSync(),this},EChartsLayer.prototype.appendData=function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];return e&&(t&&(this._incremental=function(e,t){for(var r=0,o=void 0,i=e.length;r<i;r++)e[r].seriesIndex===t.seriesIndex&&(o=r);return void 0===o?e.push(t):e[o]=t,e}(this._incremental,{data:e.data,seriesIndex:e.seriesIndex})),this.$chart.appendData({data:e.data.copyWithin(),seriesIndex:e.seriesIndex})),this},EChartsLayer.prototype.clear=function(){this._incremental=[],this.$chart.clear()},EChartsLayer.prototype.getMap=function(){return this.$Map},EChartsLayer.prototype._isVisible=function(){return this.$container&&""===this.$container.style.display},EChartsLayer.prototype.show=function(){this.$container&&(this.$container.style.display="")},EChartsLayer.prototype.hide=function(){this.$container&&(this.$container.style.display="none")},EChartsLayer.prototype.remove=function(){this.$chart.clear(),this.$chart.dispose(),this._unRegisterEvents(),this._incremental=[],delete this.$chart,delete this.$Map,this.$container.parentNode.removeChild(this.$container)},EChartsLayer.prototype.showLoading=function(){this.$chart&&this.$chart.showLoading()},EChartsLayer.prototype.hideLoading=function(){this.$chart&&this.$chart.hideLoading()},EChartsLayer.prototype._createLayerContainer=function(e,t){var r=e.getViewport(),o=this.$container=document.createElement("div");o.style.position="absolute",o.style.top="0px",o.style.left="0px",o.style.right="0px",o.style.bottom="0px";var i=C(t.target,r);if(i&&i[0]&&i[0]instanceof Element)i[0].appendChild(o);else{var a=C(".ol-overlaycontainer",r);a&&a[0]&&a[0]instanceof Element?a[0].appendChild(o):r.appendChild(o)}},EChartsLayer.prototype._resizeContainer=function(){var e=this.getMap().getSize();this.$container.style.height=e[1]+"px",this.$container.style.width=e[0]+"px"},EChartsLayer.prototype._clearAndRedraw=function(){if(this.$chart&&(!this.$container||"none"!==this.$container.style.display)&&(this.dispatchEvent({type:"redraw",source:this}),this.$options.forcedRerender&&this.$chart.clear(),this.$chart.resize(),this.$chartOptions&&(this._registerMap(),this.$chart.setOption(this.reConverData(this.$chartOptions),!1),this._incremental&&this._incremental.length>0)))for(var e=0;e<this._incremental.length;e++)this.appendData(this._incremental[e],!1)},EChartsLayer.prototype.onResize=function(){this._resizeContainer(),this._clearAndRedraw(),this.dispatchEvent({type:"change:size",source:this})},EChartsLayer.prototype.onZoomEnd=function(){this.$options.hideOnZooming&&this.show(),this._clearAndRedraw(),this.dispatchEvent({type:"zoomend",source:this})},EChartsLayer.prototype.onDragRotateEnd=function(){this.$options.hideOnRotating&&this.show(),this._clearAndRedraw(),this.dispatchEvent({type:"change:rotation",source:this})},EChartsLayer.prototype.onMoveStart=function(){this.$options.hideOnMoving&&this.hide(),this.dispatchEvent({type:"movestart",source:this})},EChartsLayer.prototype.onMoveEnd=function(){this.$options.hideOnMoving&&this.show(),this._clearAndRedraw(),this.dispatchEvent({type:"moveend",source:this})},EChartsLayer.prototype.onCenterChange=function(e){this._clearAndRedraw(),this.dispatchEvent({type:"change:center",source:this})},EChartsLayer.prototype._registerEvents=function(){var e=this.$Map,t=e.getView();this.$options.forcedPrecomposeRerender&&(this.precomposeListener_=e.on("precompose",this.reRender.bind(this))),this.sizeChangeListener_=e.on("change:size",this.onResize.bind(this)),this.resolutionListener_=t.on("change:resolution",this.onZoomEnd.bind(this)),this.centerChangeListener_=t.on("change:center",this.onCenterChange.bind(this)),this.rotationListener_=t.on("change:rotation",this.onDragRotateEnd.bind(this)),this.movestartListener_=e.on("movestart",this.onMoveStart.bind(this)),this.moveendListener_=e.on("moveend",this.onMoveEnd.bind(this))},EChartsLayer.prototype._unRegisterEvents=function(){c(this.sizeChangeListener_),this.$options.forcedPrecomposeRerender&&c(this.precomposeListener_),c(this.resolutionListener_),c(this.centerChangeListener_),c(this.rotationListener_),c(this.movestartListener_),c(this.moveendListener_),this.sizeChangeListener_=null,this.precomposeListener_=null,this.sizeChangeListener_=null,this.resolutionListener_=null,this.centerChangeListener_=null,this.rotationListener_=null,this.movestartListener_=null,this.moveendListener_=null},EChartsLayer.prototype._registerMap=function(){this._isRegistered||(echarts.registerCoordinateSystem("openlayers",I(this.getMap(),this.$options)),this._isRegistered=!0);var e=this.$chartOptions.series;if(e&&M(e))for(var t=e.length-1;t>=0;t--)this.$options.convertTypes.indexOf(e[t].type)>-1||(e[t].coordinateSystem="openlayers"),e[t].animation=!1},EChartsLayer.prototype.reConverData=function(e){var t=e.series;if(t&&t.length>0){if(!this._coordinateSystem){var r=I(this.getMap(),this.$options);this._coordinateSystem=new r}if(t&&M(t))for(var o=t.length-1;o>=0;o--)this.$options.convertTypes.indexOf(t[o].type)>-1&&t[o]&&t[o].hasOwnProperty("coordinates")&&(t[o]=z[t[o].type](e,t[o],this._coordinateSystem))}return e},EChartsLayer.prototype.render=function(){this.$container||(this._createLayerContainer(this.$Map,this.$options),this._resizeContainer()),this.$chart?this._isVisible()&&(this.$chart.resize(),this.reRender()):(this.$chart=echarts.init(this.$container,null,{renderer:"svg"}),this.$chartOptions&&(this._registerMap(),this.$chart.setOption(this.reConverData(this.$chartOptions),!1)))},EChartsLayer.prototype.reRender=function(){this._clearAndRedraw()},EChartsLayer}(h);EChartsLayer.getTarget=C,EChartsLayer.merge=b,EChartsLayer.map=P,EChartsLayer.bind=E,EChartsLayer.formatGeoJSON=function(e){var t=x(e);return{type:"FeatureCollection",crs:{},features:echarts.util.map(echarts.util.filter(t.features,function(e){return e.geometry&&e.properties&&e.geometry.coordinates.length>0}),function(e){var t=e.properties,r=e.geometry,o=r.coordinates,i=[];return"Polygon"===r.type&&i.push(o[0]),"MultiPolygon"===r.type&&echarts.util.each(o,function(e){e[0]&&i.push(e[0])}),{type:"Feature",geometry:{type:"Polygon",coordinates:i},properties:t}})}};class G{constructor(e){this.$map=e}getCenter(e){return getCenter(this.getExtent(e))}getExtent(e){return this.getGeometry(e).getExtent()}getGeometry(e){return e.getGeometry()}create(e,t,r){let o;switch(e.toLowerCase()){case"linestring":o=new LineString(t);break;case"polygon":o=new a(t);break;default:o=new Point(t)}return new Feature({geometry:o,...r})}}class W{constructor(e){this.$map=e,this.$echartsLayers={},this.$layer=new p(e),this.$drawLayer=this.$layer.createVectorLayer({name:"_visualize_draw_layer",zIndex:999}),e.addLayer(this.$drawLayer),this.$feature=new G(e),this.$style=new y(e),this.$view=new f(e)}showGuangzhou(){var e,t,r,o;new EChartsLayer((e={"\u5929\u6cb3\u533a":[113.368672,23.130389],"\u9ec4\u57d4\u533a":[113.466408,23.111777],"\u6d77\u73e0\u533a":[113.323254,23.089173],"\u8d8a\u79c0\u533a":[113.272949,23.135441],"\u8354\u6e7e\u533a":[113.250815,23.131453],"\u767d\u4e91\u533a":[113.278986,23.164151],"\u5357\u6c99\u533a":[113.530511,22.808027],"\u82b1\u90fd\u533a":[113.225806,23.412711],"\u589e\u57ce\u533a":[113.817106,23.267509],"\u4ece\u5316\u533a":[113.593464,23.555101],"\u756a\u79ba\u533a":[113.391669,22.943615]},t=function(t){for(var r=[],o=0;o<t.length;o++){var i=t[o],a=e[i[0].name],n=e[i[1].name];a&&n&&r.push({fromName:i[0].name,fromValue:i[1].value,toName:i[1].name,coords:[a,n]})}return r},r=["#a6c84c","#ffa022","#46bee9","#ff3399","#D15FEE"],o=[],[["\u589e\u57ce\u533a",[[{name:"\u589e\u57ce\u533a"},{name:"\u756a\u79ba\u533a",value:95}],[{name:"\u589e\u57ce\u533a"},{name:"\u4ece\u5316\u533a",value:90}],[{name:"\u589e\u57ce\u533a"},{name:"\u5929\u6cb3\u533a",value:80}],[{name:"\u589e\u57ce\u533a"},{name:"\u82b1\u90fd\u533a",value:70}],[{name:"\u589e\u57ce\u533a"},{name:"\u5357\u6c99\u533a",value:60}],[{name:"\u589e\u57ce\u533a"},{name:"\u767d\u4e91\u533a",value:50}],[{name:"\u589e\u57ce\u533a"},{name:"\u8354\u6e7e\u533a",value:40}],[{name:"\u589e\u57ce\u533a"},{name:"\u8d8a\u79c0\u533a",value:30}],[{name:"\u589e\u57ce\u533a"},{name:"\u6d77\u73e0\u533a",value:20}],[{name:"\u589e\u57ce\u533a"},{name:"\u589e\u57ce\u533a",value:10}],[{name:"\u589e\u57ce\u533a"},{name:"\u9ec4\u57d4\u533a",value:10}]]],["\u5357\u6c99\u533a",[[{name:"\u5357\u6c99\u533a"},{name:"\u9ec4\u57d4\u533a",value:95}],[{name:"\u5357\u6c99\u533a"},{name:"\u6d77\u73e0\u533a",value:90}],[{name:"\u5357\u6c99\u533a"},{name:"\u8d8a\u79c0\u533a",value:80}],[{name:"\u5357\u6c99\u533a"},{name:"\u8354\u6e7e\u533a",value:70}],[{name:"\u5357\u6c99\u533a"},{name:"\u5929\u6cb3\u533a",value:60}],[{name:"\u5357\u6c99\u533a"},{name:"\u767d\u4e91\u533a",value:50}],[{name:"\u5357\u6c99\u533a"},{name:"\u82b1\u90fd\u533a",value:40}],[{name:"\u5357\u6c99\u533a"},{name:"\u589e\u57ce\u533a",value:30}],[{name:"\u5357\u6c99\u533a"},{name:"\u4ece\u5316\u533a",value:20}],[{name:"\u5357\u6c99\u533a"},{name:"\u756a\u79ba\u533a",value:10}]]],["\u6d77\u73e0\u533a",[[{name:"\u6d77\u73e0\u533a"},{name:"\u9ec4\u57d4\u533a",value:95}],[{name:"\u6d77\u73e0\u533a"},{name:"\u767d\u4e91\u533a",value:90}],[{name:"\u6d77\u73e0\u533a"},{name:"\u8d8a\u79c0\u533a",value:80}],[{name:"\u6d77\u73e0\u533a"},{name:"\u8354\u6e7e\u533a",value:70}],[{name:"\u6d77\u73e0\u533a"},{name:"\u5929\u6cb3\u533a",value:60}],[{name:"\u6d77\u73e0\u533a"},{name:"\u5357\u6c99\u533a",value:50}],[{name:"\u6d77\u73e0\u533a"},{name:"\u82b1\u90fd\u533a",value:40}],[{name:"\u6d77\u73e0\u533a"},{name:"\u589e\u57ce\u533a",value:30}],[{name:"\u6d77\u73e0\u533a"},{name:"\u4ece\u5316\u533a",value:20}],[{name:"\u6d77\u73e0\u533a"},{name:"\u756a\u79ba\u533a",value:10}]]],["\u4ece\u5316\u533a",[[{name:"\u4ece\u5316\u533a"},{name:"\u9ec4\u57d4\u533a",value:95}],[{name:"\u4ece\u5316\u533a"},{name:"\u767d\u4e91\u533a",value:90}],[{name:"\u4ece\u5316\u533a"},{name:"\u8d8a\u79c0\u533a",value:80}],[{name:"\u4ece\u5316\u533a"},{name:"\u8354\u6e7e\u533a",value:70}],[{name:"\u4ece\u5316\u533a"},{name:"\u5929\u6cb3\u533a",value:60}],[{name:"\u4ece\u5316\u533a"},{name:"\u5357\u6c99\u533a",value:50}],[{name:"\u4ece\u5316\u533a"},{name:"\u82b1\u90fd\u533a",value:40}],[{name:"\u4ece\u5316\u533a"},{name:"\u589e\u57ce\u533a",value:30}],[{name:"\u4ece\u5316\u533a"},{name:"\u6d77\u73e0\u533a",value:20}],[{name:"\u4ece\u5316\u533a"},{name:"\u756a\u79ba\u533a",value:10}]]],["\u82b1\u90fd\u533a",[[{name:"\u82b1\u90fd\u533a"},{name:"\u9ec4\u57d4\u533a",value:95}],[{name:"\u82b1\u90fd\u533a"},{name:"\u767d\u4e91\u533a",value:90}],[{name:"\u82b1\u90fd\u533a"},{name:"\u8d8a\u79c0\u533a",value:80}],[{name:"\u82b1\u90fd\u533a"},{name:"\u8354\u6e7e\u533a",value:70}],[{name:"\u82b1\u90fd\u533a"},{name:"\u5929\u6cb3\u533a",value:60}],[{name:"\u82b1\u90fd\u533a"},{name:"\u5357\u6c99\u533a",value:50}],[{name:"\u82b1\u90fd\u533a"},{name:"\u4ece\u5316\u533a",value:40}],[{name:"\u82b1\u90fd\u533a"},{name:"\u589e\u57ce\u533a",value:30}],[{name:"\u82b1\u90fd\u533a"},{name:"\u6d77\u73e0\u533a",value:20}],[{name:"\u82b1\u90fd\u533a"},{name:"\u756a\u79ba\u533a",value:10}]]]].forEach(function(i,a){o.push({name:i[0],type:"lines",zlevel:1,effect:{show:!0,period:6,trailLength:.7,color:"#fff",symbolSize:3,shadowBlur:4.4},lineStyle:{normal:{color:r[a],width:0,curveness:.2}},data:t(i[1])},{name:i[0],type:"lines",zlevel:2,symbol:["none","arrow"],symbolSize:10,effect:{show:!0,period:6,trailLength:0,symbolSize:6},lineStyle:{normal:{color:r[a],width:1,opacity:.5,curveness:.2}},data:t(i[1])},{name:i[0],type:"effectScatter",zlevel:2,rippleEffect:{brushType:"stroke"},label:{normal:{show:0===a,position:"right",formatter:"{b}"}},symbolSize:function(e){return e[2]/10},itemStyle:{normal:{color:r[a]}},data:i[1].map(function(t){return{name:t[1].name,value:e[t[1].name].concat([t[1].value])}})})}),{tooltip:{trigger:"item",formatter:function(e){return e.data.fromName?e.data.fromName+" > "+e.data.toName+" <br/>\u6d41\u91cf\u6570 : "+e.data.fromValue:e.name+"<br/>\u6d41\u5411\u5e7f\u5dde\u4eba\u6570\uff1a"+e.value[2]}},legend:{orient:"vertical",top:"5%",left:"right",data:["\u589e\u57ce\u533a","\u5357\u6c99\u533a","\u6d77\u73e0\u533a","\u4ece\u5316\u533a","\u82b1\u90fd\u533a"],textStyle:{color:"#fff"},selectedMode:"mutipla",bottom:"50%"},visualMap:{min:0,max:100,calculable:!0,inRange:{color:["#50a3ba","#eac736","#d94e5d"]},textStyle:{color:"#fff"},bottom:"10%"},series:o})).appendTo(this.$map)}drawODLine(e={}){let t=[];const{series:r,id:o,tooltip:i,effectPeriod:a,effectSize:n,curveness:s,lineColor:l,effectType:c,lineWidth:h,effectColor:m,options:u,scatterColor:d,lineOpacity:p,doubleDirection:g}=e;let f=[],y=[];r.forEach(e=>{const{from:t,to:r,lineWidth:o,lineColor:i,speed:a,effectColor:n,effectSize:s,effectPeriod:l,effectType:c,curveness:h,legend:m,attr:u,lineOpacity:d}=e;t.showScatter&&f.push({name:t.name,value:t.coordinate,symbol:"circle",symbolSize:t.scatterSize||10,itemStyle:{normal:{show:!1,color:t.scatterColor||"#fff"}},label:{normal:{formatter:"{b}",position:t.labelPosition||"right",show:!1!==t.showLabel,color:t.labelColor||t.scatterColor||"#fff",fontSize:t.fontSize}},...t.attr}),r.length?r.forEach(e=>{e.showScatter&&f.push({name:e.name,value:e.coordinate,label:{normal:{formatter:"{b}",position:e.labelPosition||"right",show:!1!==e.showLabel,color:r.labelColor||r.scatterColor||"#fff",fontSize:r.fontSize}},...e.attr}),y.push({name:m,coords:[t.coordinate,e.coordinate],from:t.name,to:e.name,...e.attr})}):r.showScatter&&f.push({name:r.name,value:r.coordinate,symbol:"pin",symbolSize:r.scatterSize||10,itemStyle:{normal:{show:!1,color:r.scatterColor||"#fff"}},label:{normal:{formatter:"{b}",position:r.labelPosition||"right",show:!1!==r.showLabel,color:r.labelColor||r.scatterColor||"#fff",fontSize:r.fontSize}},...r.attr})}),t.push({type:"effectScatter",coordinateSystem:"geo",zlevel:2,rippleEffect:{period:4,brushType:"fill",scale:4},label:{normal:{show:!0,position:"right",offset:[5,0],formatter:"{b}"},emphasis:{show:!0}},symbol:"circle",symbolSize:10,itemStyle:{normal:{show:!1,color:d||"#fff"}},data:f}),console.log(y);let v=y.concat();console.log(g),g&&v.forEach(e=>{v.push({coords:[e.coords[1],e.coords[0]],lineStyle:{normal:{width:0,curveness:-s}}}),console.log(v)}),console.log(v),t.push({type:"lines",zlevel:1,large:!1,progressive:20,effect:{show:!0,period:a||3,symbol:c||"arrow",symbolSize:n||1,trailLength:.4,color:m||"#0bc2ff",loop:!0},lineStyle:{normal:{width:0,curveness:s||.2}},data:v}),t.push({type:"lines",zlevel:1,large:!1,progressive:20,effect:{show:!1},lineStyle:{normal:{color:l||"#1fe1ff",width:h||1,opacity:p,curveness:s||.2}},data:y});let w=new EChartsLayer({tooltip:{trigger:"item",formatter:i},hideOnMoving:!0,legend:{show:!0,type:"scroll",orient:"horizontal",left:"500px",right:"400px",top:"bottom",padding:15,animation:!1,pageIconColor:"#aaa",inactiveColor:"#aaa",pageIconInactiveColor:"#2f4554",pageTextStyle:{color:"#aaa"},selectedMode:"multiple",textStyle:{color:"#fff"},data:["\u5408\u80a5"]},series:t},u);this.$echartsLayers[o]=w,w.appendTo(this.$map)}static example(){var e={"\u4e0a\u6d77":[121.4648,31.2891],"\u5c3c\u65e5\u5229\u4e9a":[-4.388361,11.186148],"\u7f8e\u56fd\u6d1b\u6749\u77f6":[-118.24311,34.052713],"\u9999\u6e2f\u90a6\u6cf0":[114.195466,22.282751],"\u7f8e\u56fd\u829d\u52a0\u54e5":[-87.801833,41.870975],"\u52a0\u7eb3\u5e93\u9a6c\u897f":[-4.62829,7.72415],"\u82f1\u56fd\u66fc\u5f7b\u65af\u7279":[-1.657222,51.886863],"\u5fb7\u56fd\u6c49\u5821":[10.01959,54.38474],"\u54c8\u8428\u514b\u65af\u5766\u963f\u62c9\u6728\u56fe":[45.326912,41.101891],"\u4fc4\u7f57\u65af\u4f0a\u5c14\u5e93\u8328\u514b":[89.116876,67.757906],"\u5df4\u897f":[-48.678945,-10.493623],"\u57c3\u53ca\u8fbe\u7c73\u57c3\u5854":[31.815593,31.418032],"\u897f\u73ed\u7259\u5df4\u585e\u7f57\u7eb3":[2.175129,41.385064],"\u67ec\u57d4\u5be8\u91d1\u8fb9":[104.88659,11.545469],"\u610f\u5927\u5229\u7c73\u5170":[9.189948,45.46623],"\u4e4c\u62c9\u572d\u8499\u5f97\u7ef4\u7684\u4e9a":[-56.162231,-34.901113],"\u83ab\u6851\u6bd4\u514b\u9a6c\u666e\u6258":[32.608571,-25.893473],"\u963f\u5c14\u53ca\u5229\u4e9a\u963f\u5c14\u53ca\u5c14":[3.054275,36.753027],"\u963f\u8054\u914b\u8fea\u62dc":[55.269441,25.204514],"\u5308\u7259\u5229\u5e03\u8fbe\u4f69\u65af":[17.108519,48.179162],"\u6fb3\u5927\u5229\u4e9a\u6089\u5c3c":[150.993137,-33.675509],"\u7f8e\u56fd\u52a0\u5dde":[-121.910642,41.38028],"\u6fb3\u5927\u5229\u4e9a\u58a8\u5c14\u672c":[144.999416,-37.781726],"\u58a8\u897f\u54e5":[-99.094092,19.365711],"\u52a0\u62ff\u5927\u6e29\u54e5\u534e":[-123.023921,49.311753]},t=function(t){for(var r=[],o=0;o<t.length;o++){var i=t[o],a=e[i[0].name],n=e[i[1].name];a&&n&&r.push([{coord:a,value:i[0].value},{coord:n}])}return r},r=[];[["\u4e0a\u6d77",[[{name:"\u5c3c\u65e5\u5229\u4e9a",value:9100},{name:"\u4e0a\u6d77"}],[{name:"\u7f8e\u56fd\u6d1b\u6749\u77f6",value:2370},{name:"\u4e0a\u6d77"}],[{name:"\u9999\u6e2f\u90a6\u6cf0",value:3130},{name:"\u4e0a\u6d77"}],[{name:"\u7f8e\u56fd\u829d\u52a0\u54e5",value:2350},{name:"\u4e0a\u6d77"}],[{name:"\u52a0\u7eb3\u5e93\u9a6c\u897f",value:5120},{name:"\u4e0a\u6d77"}],[{name:"\u82f1\u56fd\u66fc\u5f7b\u65af\u7279",value:3110},{name:"\u4e0a\u6d77"}],[{name:"\u5fb7\u56fd\u6c49\u5821",value:6280},{name:"\u4e0a\u6d77"}],[{name:"\u54c8\u8428\u514b\u65af\u5766\u963f\u62c9\u6728\u56fe",value:7255},{name:"\u4e0a\u6d77"}],[{name:"\u4fc4\u7f57\u65af\u4f0a\u5c14\u5e93\u8328\u514b",value:8125},{name:"\u4e0a\u6d77"}],[{name:"\u5df4\u897f",value:3590},{name:"\u4e0a\u6d77"}],[{name:"\u57c3\u53ca\u8fbe\u7c73\u57c3\u5854",value:3590},{name:"\u4e0a\u6d77"}],[{name:"\u897f\u73ed\u7259\u5df4\u585e\u7f57\u7eb3",value:3590},{name:"\u4e0a\u6d77"}],[{name:"\u67ec\u57d4\u5be8\u91d1\u8fb9",value:3590},{name:"\u4e0a\u6d77"}],[{name:"\u610f\u5927\u5229\u7c73\u5170",value:3590},{name:"\u4e0a\u6d77"}],[{name:"\u4e4c\u62c9\u572d\u8499\u5f97\u7ef4\u7684\u4e9a",value:3590},{name:"\u4e0a\u6d77"}],[{name:"\u83ab\u6851\u6bd4\u514b\u9a6c\u666e\u6258",value:3590},{name:"\u4e0a\u6d77"}],[{name:"\u963f\u5c14\u53ca\u5229\u4e9a\u963f\u5c14\u53ca\u5c14",value:3590},{name:"\u4e0a\u6d77"}],[{name:"\u963f\u8054\u914b\u8fea\u62dc",value:3590},{name:"\u4e0a\u6d77"}],[{name:"\u5308\u7259\u5229\u5e03\u8fbe\u4f69\u65af",value:3590},{name:"\u4e0a\u6d77"}],[{name:"\u6fb3\u5927\u5229\u4e9a\u6089\u5c3c",value:3590},{name:"\u4e0a\u6d77"}],[{name:"\u7f8e\u56fd\u52a0\u5dde",value:3590},{name:"\u4e0a\u6d77"}],[{name:"\u6fb3\u5927\u5229\u4e9a\u58a8\u5c14\u672c",value:3590},{name:"\u4e0a\u6d77"}],[{name:"\u58a8\u897f\u54e5",value:3590},{name:"\u4e0a\u6d77"}],[{name:"\u52a0\u62ff\u5927\u6e29\u54e5\u534e",value:3590},{name:"\u4e0a\u6d77"}]]]].forEach(function(o,i){r.push({type:"lines",zlevel:2,effect:{show:!0,period:4,trailLength:.02,symbol:"arrow",symbolSize:5},lineStyle:{normal:{width:1,opacity:0,curveness:.3}},data:t(o[1])},{type:"effectScatter",coordinateSystem:"geo",zlevel:2,rippleEffect:{period:4,brushType:"stroke",scale:4},label:{normal:{show:!0,position:"right",offset:[5,0],formatter:"{b}"},emphasis:{show:!0}},symbol:"circle",symbolSize:function(e){return 4+e[2]/1e3},itemStyle:{normal:{show:!1}},data:o[1].map(function(t){return{name:t[0].name,value:e[t[0].name].concat([t[0].value])}})},{type:"scatter",coordinateSystem:"geo",zlevel:2,rippleEffect:{period:4,brushType:"stroke",scale:4},label:{normal:{show:!0,position:"right",color:"#00ffff",formatter:"{b}",textStyle:{color:"#0bc7f3"}},emphasis:{show:!0}},symbol:"pin",symbolSize:30,itemStyle:{normal:{show:!0,color:"#9966cc"}},data:[{name:o[0],value:e[o[0]].concat([100])}]})})}drawScatter(e){let t=[];const{series:r,id:o}=e;this.remove(o),r.forEach(e=>{const{coords:r,color:o,size:i}=e;let a=[];a.push(r),t.push({type:"effectScatter",coordinateSystem:"geo",zlevel:2,rippleEffect:{period:4,brushType:"fill",scale:4},label:{normal:{show:!0,position:"right",offset:[5,0],formatter:"{b}"},emphasis:{show:!0}},symbol:"circle",symbolSize:i||10,itemStyle:{normal:{show:!1,color:o}},data:a})});let i=new EChartsLayer({backgroundColor:"transparent",series:t,tooltip:{trigger:"item",formatter:function(e){console.log(e)}}});this.$echartsLayers[o]=i,i.appendTo(this.$map)}drawTrafficFlow(e,t){let r=[],o=[],i=[];t.forEach(e=>{let t=e.get("flow");t>=500?i.push(e.getGeometry().getCoordinates()[0]):t>=200?o.push(e.getGeometry().getCoordinates()[0]):r.push(e.getGeometry().getCoordinates()[0])});let a=new EChartsLayer({tooltip:{trigger:"item",formatter:function(e,t,r){if(e.data.flow)return"\u6d41\u91cf\uff1a "+e.data.flow}},series:[{type:"lines",coordinateSystem:"geo",hideOnMoving:!0,polyline:!0,data:o,zlevel:2,effect:{show:!0,constantSpeed:40,trailLength:.4,color:"#ff9210",symbolSize:6},lineStyle:{normal:{width:0,color:"#fffe00"}}},{type:"lines",coordinateSystem:"geo",hideOnMoving:!0,polyline:!0,data:i,zlevel:2,effect:{show:!0,constantSpeed:1,trailLength:1,color:"#ff1aec",symbolSize:1,trailOpacity:1,spotIntensity:10},lineStyle:{normal:{width:0,color:"#fffe00"}}},{type:"lines",coordinateSystem:"geo",hideOnMoving:!0,polyline:!0,data:r,zlevel:2,effect:{show:!0,constantSpeed:20,trailLength:.3,color:"#07b500",symbolSize:6},lineStyle:{normal:{width:0}}}]});this.$echartsLayers[e]=a,a.appendTo(this.$map)}remove(e){if(void 0===e){for(let e in this.$echartsLayers){let t=this.$echartsLayers[e];t&&t.remove&&t.remove()}this.$echartsLayers={}}else{let t=this.$echartsLayers[e];if(!t)return;const{type:r}=t;if(console.log(t),"track"==r){const{echartslayer:e,animationCoords:r,breakPoints:o,trackFeature:i,timer:a,moveFeature:n,fromFeature:s,toFeature:l,moveText:c}=t;e&&e.remove&&e.remove(),this.$drawLayer.getSource().removeFeature(i),o.forEach(e=>{this.removeFeature(e)}),this.removeFeature(n),this.removeFeature(s),this.removeFeature(l),this.removeFeature(c),t.timer&&clearInterval(t.timer)}else if("multiColorLine"==r){const{lines:e}=t;e.forEach(e=>{this.$drawLayer.getSource().removeFeature(e)})}else t&&t.remove&&t.remove();this.$echartsLayers[e]=void 0}}removeFeature(e){e&&this.$drawLayer.getSource().removeFeature(e)}removeAllTrack(){console.log(this.$echartsLayers)}hide(e){if(console.log(this.$echartsLayers),void 0===e)for(let e in this.$echartsLayers){let t=this.$echartsLayers[e];t&&t.hide&&t.hide()}else{let t=this.$echartsLayers[e];t&&t.hide&&t.hide()}}show(e){if(void 0===e)for(let e in this.$echartsLayers){let t=this.$echartsLayers[e];t&&t.show&&t.show()}else{let t=this.$echartsLayers[e];t&&t.show&&t.show()}}update(e){if(void 0===e)for(let e in this.$echartsLayers){let t=this.$echartsLayers[e];t&&t._clearAndRedraw&&t._clearAndRedraw()}else{let t=this.$echartsLayers[e];t&&t._clearAndRedraw&&t._clearAndRedraw()}}flowingLight(e={}){const{coords:t,id:r}=e;let o=[];console.log(t);for(var i=0;i<t.length;i++)o.push({coords:t[i],lineStyle:{color:echarts.color.modifyHSL("#ff440e"),width:.1},value:200*Math.random()});console.log(o);var a={tooltip:{trigger:"item",formatter:function(e,t,r){if(e.data.flow)return"\u6d41\u91cf\uff1a "+e.data.flow}},series:[{type:"lines",coordinateSystem:"geo",hideOnMoving:!0,polyline:!0,data:o,zlevel:2,blendMode:"lighter",effect:{show:!0,constantSpeed:10,trailWidth:2,trailLength:.6,trailOpacity:1,spotIntensity:10,symbolSize:1}},{type:"lines",coordinateSystem:"geo",hideOnMoving:!0,polyline:!0,data:t,zlevel:1,lineStyle:{normal:{width:1,color:echarts.color.modifyHSL("#ff440e")}}}]};let n=new EChartsLayer(a);this.$echartsLayers[r]=n,n.appendTo(this.$map)}flowLight(e={}){const{data:t,id:r,options:o,effectSize:i,effectColor:a,color:n,width:s}=e;console.log(t);let l=[],c=[],h=[];t.forEach((e,t)=>{let r=m(e.coords),o=1e3*u(r);for(let t=0;t<Math.round(o/600);t++)c.push({coords:e.coords,effect:{constantSpeed:60,delay:300*t,symbolSize:e.effectSize,color:e.effectColor}});h.push({coords:e.coords,lineStyle:{normal:{width:e.width||s,color:e.color||"#e607ff"}}})});let d=new EChartsLayer({series:l=[{type:"lines",coordinateSystem:"geo",hideOnMoving:!0,polyline:!0,data:c,zlevel:2,effect:{show:!0,period:3,symbol:"path://M73.7,1.7c0,0-73.2,33.5-74.2,39.2S0,70.7,0,70.7l73.7-34.5L150,70.7V36.2L73.7,1.7z",symbolSize:i||5,trailLength:.3,color:a||"#f6f2ff",loop:!0},lineStyle:{normal:{width:0}}},{type:"lines",coordinateSystem:"geo",hideOnMoving:!0,polyline:!0,data:h,zlevel:2,lineStyle:{normal:{width:s||3,color:n||"#ff3d03",opacity:1}}}]},o);this.$echartsLayers[r]=d,d.appendTo(this.$map)}multiColorLine(e={}){const{id:t,data:r}=e;let o=[];e.data.forEach(e=>{const{color:t,coords:r,width:i,attr:a}=e;let n=this.$feature.create("lineString",r,a);n.setStyle(this.$style.stroke({width:i||3,color:t})),this.$drawLayer.getSource().addFeature(n),o.push(n)}),this.$echartsLayers[t]={type:"multiColorLine",lines:o}}drawTrack(e={}){const{id:t,coordinates:r,lineColor:o,lineWidth:i,trackColor:a,breakPoint:n,step:s,movePoint:l,ODPoint:c,moveText:h}=e;let p=this.$feature.create("lineString",r);p.setStyle(this.$style.stroke({color:o||"#f00",width:i||5})),this.$drawLayer.getSource().addFeature(p);let g=r[0],f=[],y=[];if(n){const{color:e,radius:t,coordinates:r}=n;r.forEach((r,o)=>{let i=this.$feature.create("point",r);i.setStyle(this.$style.circle({color:e||"#fff723",radius:t||6})),f.push(i),this.$drawLayer.getSource().addFeature(i),console.log(g,r);let a=m([g,r]),n=1e3*u(a);y.push({coordinate:r,length:n,index:o})})}console.log(r);let v=m(r),w=[r[0]],S=0,$=s||10,L=1e3*u(v),M=s||30,b=0;for(var C=0;C<2e4;C++){for(var P=d(v,S/1e3,$/1e3,{units:"kilometers"}).geometry.coordinates,E=0;E<P.length-1;E++)w.push(P[E]);if(S+=M,$+=M,(b+=M)>=L){w.push(r[r.length-1]);break}}let x,T,I=[];if(c){const{from:e,to:t}=c;I=[{name:e.name,value:r[0],symbol:e.src,symbolSize:e.size},{name:t.name,value:r[r.length-1],symbol:t.src,symbolSize:t.size}],x=this.$feature.create("Point",r[0]),console.log(e),x.setStyle(e.style),(T=this.$feature.create("Point",r[r.length-1])).setStyle(t.style),this.$drawLayer.getSource().addFeature(x),this.$drawLayer.getSource().addFeature(T)}let z=l&&l.style,k=h&&h.style;this.$echartsLayers[t]={type:"track",fromFeature:x,toFeature:T,moveFeatureStyle:z,trackFeature:p,breakPoints:f,animateCoords:w,steps:2e4,coordinates:r,breakPointsData:y,moveTextStyle:k}}playTrack(e={}){let{id:t,end:r,interval:o,startIndex:i,onPlaying:a,focusOnMoving:n}=e,s=this.$echartsLayers[t];if(!s||"track"!==s.type)return void console.error("\u4e0d\u5c5e\u4e8e\u8f68\u8ff9\u6216\u8f68\u8ff9\u4e0d\u5b58\u5728");console.log(s);let{animateCoords:l,echartslayer:c,coordinates:h,currentIndex:m,moveFeature:u,moveFeatureStyle:d,trackFeature:p,moveText:g,moveTextStyle:f}=s;n&&this.$view.getView().fit(p.getGeometry().getExtent(),{maxZoom:n.maxZoom||14,duration:n.duration||500}),u||(u=this.$feature.create("Point",h[0]),g=this.$feature.create("Point",h[0]),u.setStyle(d||this.$style.circle({color:"#f00",radius:5})),g.setStyle(f||this.$style.circle({color:"#f00",radius:5})),this.$drawLayer.getSource().addFeature(u),this.$drawLayer.getSource().addFeature(g),s.moveFeature=u,s.moveText=g),m>=l.length-1&&(m=0);let y=void 0!==i?i:m||0,v=l.length;s.timer=setInterval(()=>{l[y+1]||(u.getGeometry().setCoordinates(h[h.length-1]),g.getGeometry().setCoordinates(h[h.length-1]),this.$drawLayer.getSource().removeFeature(u),this.$drawLayer.getSource().removeFeature(g),s.moveFeature=void 0,s.moveText=void 0,clearInterval(s.timer),s.currentIndex=0,r&&r()),a&&a(y,v,u,g),u.getGeometry().setCoordinates(l[y]),g.getGeometry().setCoordinates(l[y]),s.currentIndex=y,y++},o||20)}pauseTrack(e){let t=this.$echartsLayers[e];if(!t||"track"!==t.type)return void console.error("\u4e0d\u5c5e\u4e8e\u8f68\u8ff9\u6216\u8f68\u8ff9\u4e0d\u5b58\u5728");const{timer:r}=t;r&&clearInterval(r)}resetTrack(e){let t=this.$echartsLayers[e];if(!t||"track"!==t.type)return void console.error("\u4e0d\u5c5e\u4e8e\u8f68\u8ff9\u6216\u8f68\u8ff9\u4e0d\u5b58\u5728");let{timer:r,currentIndex:o,moveFeature:i,moveText:a}=t;r&&clearInterval(r),t.currentIndex=0,i&&(this.$drawLayer.getSource().removeFeature(i),t.moveFeature=void 0),this.removeFeature(a),t.moveText=void 0}changeTrackStyle(e={}){const{id:t,color:r,width:o}=e;let i=this.$echartsLayers[t];if(console.log(i),!i)return void console.error("\u6ca1\u6709\u83b7\u53d6\u5230\u8be5\u8f68\u8ff9, \u65e0\u6cd5\u6539\u53d8\u989c\u8272");const{trackFeature:a}=i;let n=a.getStyle().getStroke();r&&n.setColor(r),o&&n.setWidth(o),this.$drawLayer.getSource().refresh()}}class F{constructor(){}getVectorSourceByGeoserverWFS(e={}){const{layerName:r,filter:o,geoserverIp:i,layerPre:a}=e;let n=a?a+r:r,s=new t({format:new GeoJSON,loader:function(e,t,r){var a="BBOX(geom,"+e.join(",")+")";o&&(a+=" and "+o);var l=i+"geoserver/cite/ows?service=WFS&version=1.0.0&request=GetFeature&typename=cite:"+n+"&outputFormat=application/json&CQL_FILTER="+a+"&srsname=EPSG:4326",c=new XMLHttpRequest;c.open("GET",encodeURI(l));var h=function(e){console.info(e)};c.onerror=h,c.onload=function(e){if(200===c.status){var t=JSON.parse(c.responseText);s.addFeatures(s.getFormat().readFeatures(t))}else h()},c.send()},wrapX:!1,strategy:bbox});return s}WMSGetFeatureInfo(e={}){const{wmsSource:t,coordinate:r,viewResolution:o,success:i,layers:a}=e;console.log(t);let n=t.getGetFeatureInfoUrl(r,o,"EPSG:4326",{INFO_FORMAT:"application/json",QUERY_LAYERS:a,LAYERS:a,FEATURE_COUNT:50});fetch(n).then(function(e){return e.text()}).then(function(e){i&&i(e)})}}class R{constructor(e){this.$map=e}lineOffset(){}}class O{constructor(e){this.$map=e,this.$layer=new p(e),this.$style=new y(e),this.$feature=new G(this.$map)}init(e={}){const{data:t,style:r,interval:o,autoPlay:i}=e;let a=this;this.data=t,this.$trafficSimulateLayer||(this.$trafficSimulateLayer=this.$layer.createVectorLayer({name:"trafficSimulateLayer",style:r}),this.$map.addLayer(this.$trafficSimulateLayer)),this.$trafficSimulateIndex||(this.$trafficSimulateIndex=0);let n=this.$trafficSimulateIndex,s=a.$trafficSimulateLayer.getSource();this.timer=setInterval(()=>{s.clear(),Object.keys(t).forEach(function(e){t[e][n].forEach(e=>{let t=a.$feature.create("point",[e.x,e.y],{...e});s.addFeature(t)})}),n++,this.$trafficSimulateIndex=n},o||1e3)}play(e={}){const{data:t,interval:r}=e;let o=t||this.data,i=this.$trafficSimulateIndex||0;console.log(i);let a=this.$trafficSimulateLayer.getSource(),n=this;this.timer=setInterval(()=>{a.clear(),Object.keys(o).forEach(function(e){let t=o[e][i];t?t.forEach(e=>{let t=n.$feature.create("point",[e.x,e.y],{...e});a.addFeature(t)}):clearInterval(n.timer)}),i++,n.$trafficSimulateIndex=i},r||1e3)}pause(){this.timer?clearInterval(this.timer):console.log("\u6ca1\u6709\u6b63\u5728\u64ad\u653e\u7684\u4ea4\u901a\u4eff\u771f")}clear(){this.timer&&clearInterval(this.timer),this.$trafficSimulateLayer&&this.$trafficSimulateLayer.getSource().clear(),this.$trafficSimulateIndex=0}}export default class{constructor(e){this.init(e),this.map=new g(this.$map),this.layer=new p(this.$map),this.style=new y(this.$map),this.view=new f(this.$map),this.tools=new w(this.$map),this.source=new F(this.$map),this.interactions=new v(this.$map),this.interaction=this.interactions,this.visualize=new W(this.$map),this.feature=new G(this.$map),this.geospatial=new R(this.$map),this.trafficSimulate=new O(this.$map)}init(t={}){this.$map=new e({target:t.target,view:new View({projection:t.projection||"EPSG:4326",center:t.center||[118.77,30.945],zoom:t.zoom||12}),interactions:defaults({doubleClickZoom:!1}),layers:t.layers,controls:[]})}}
